<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planejador Estratégico de Campanha</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .step-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .step-number {
            background-color: #1d4ed8; /* blue-800 */
            color: white;
            border-radius: 50%;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.25rem;
            flex-shrink: 0;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .details-row {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .details-row.show {
            max-height: 500px; /* A large enough value to show content */
        }
        .details-cell {
            padding: 0 !important;
            border: none !important;
        }
        .rotate-180 {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
        <div class="text-center mb-10">
            <h1 class="text-4xl lg:text-5xl font-bold text-gray-800">Planejador de Campanha - Santa Catarina</h1>
            <p class="text-lg text-gray-600 mt-3">Calcule a meta de votos e o custo estimado para sua eleição.</p>
        </div>

        <div class="space-y-8">
            <!-- Passo 1: Defina seu Objetivo -->
            <div class="step-card p-6">
                <div class="flex items-start space-x-4">
                    <div class="step-number">1</div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Defina seu Objetivo</h2>
                        <p class="text-gray-500">Selecione o cenário e o partido que deseja analisar.</p>
                    </div>
                </div>
                <div id="configuracao-eleicao" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="tipoEleicao" class="block text-sm font-medium text-gray-700 mb-1">Cargo</label>
                        <select id="tipoEleicao" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                    </div>
                     <div id="ano-group">
                        <label for="anoEleicao" class="block text-sm font-medium text-gray-700 mb-1">Ano da Eleição para Análise</label>
                        <select id="anoEleicao" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                    </div>
                    <div id="cidade-group" class="hidden md:col-span-2">
                        <label for="cidade" class="block text-sm font-medium text-gray-700 mb-1">Cidade</label>
                        <select id="cidade" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                    </div>
                    <div class="md:col-span-2">
                        <label for="partido-select" class="block text-sm font-medium text-gray-700 mb-1">Partido para Análise</label>
                        <select id="partido-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm"></select>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-8 text-center">
            <button onclick="realizarAnalise()" class="bg-blue-700 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105 text-lg">
                Calcular Meta de Votos
            </button>
        </div>

        <!-- Painel de Resultados -->
        <div id="resultado-analise" class="mt-10 space-y-8 fade-in hidden"></div>
    </div>

    <!-- Modal de Detalhes de Custo -->
    <div id="custo-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50" onclick="closeCustoModal()">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6 relative" onclick="event.stopPropagation()">
            <button onclick="closeCustoModal()" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h3 class="text-xl font-bold text-gray-800 mb-4">Composição do Custo Estimado</h3>
            <div id="modal-custo-body" class="space-y-3 text-sm">
                <!-- Conteúdo dinâmico aqui -->
            </div>
            <p class="text-xs text-gray-500 mt-4">*Fonte: As porcentagens são baseadas em médias de mercado para campanhas políticas e servem como referência para planejamento. Os valores reais podem variar.</p>
        </div>
    </div>

    <script>
        // --- DATA MOCKS ---
        const DADOS_ELEICOES = {
            'SC': {
                'governador': {
                    custo_medio_voto: 30.00,
                    historico: [
                        { ano: 2022, eleitorado: 5495133, votos_validos: 3600721, partidos: { 'PL': {votos: 2983949}, 'PT': {votos: 1237016} }, eleito: { nome: 'Jorginho Mello', votos: 2983949 } },
                        { ano: 2018, eleitorado: 5127453, votos_validos: 3458169, partidos: { 'PSL': {votos: 2644179}, 'MDB': {votos: 813990} }, eleito: { nome: 'Carlos Moisés', votos: 2644179 } }
                    ]
                },
                'senador': {
                    custo_medio_voto: 35.00,
                    historico: [
                        { ano: 2022, eleitorado: 5495133, votos_validos: 3746109, partidos: { 'PL': {votos: 1627844}, 'PSD': {votos: 1302263} }, eleito: { nome: 'Jorge Seif', votos: 1627844, votos_blumenau: 65332, cidade: 'Itajaí', pautas: ['Pesca e Agronegócio', 'Defesa do Governo Bolsonaro', 'Liberalismo Econômico'], top_cidades: [{cidade: 'Itajaí', votos: 80000}, {cidade: 'Joinville', votos: 75000}, {cidade: 'Blumenau', votos: 65332}] } },
                        { ano: 2018, eleitorado: 5127453, votos_validos: 6582490, partidos: { 'PSL': {votos: 114887}, 'MDB': {votos: 110943} }, eleito: { nome: 'Esperidião Amin', votos: 1225969, votos_blumenau: 55123, cidade: 'Florianópolis', pautas: ['Infraestrutura e Logística', 'Experiência Administrativa', 'Municipalismo'], top_cidades: [{cidade: 'Florianópolis', votos: 150000}, {cidade: 'Joinville', votos: 90000}, {cidade: 'Blumenau', votos: 55123}]} }
                    ]
                },
                'df': {
                    vagas: 16,
                    custo_medio_voto: 22.00,
                    historico: [
                        { ano: 2022, eleitorado: 5495133, votos_validos: 4190847, partidos: { 'PL': { votos: 1173468, bancada: 6, eleitos: [ { nome: 'CAROLINE DE TONI', votos: 227632, votos_blumenau: 8150, cidade: 'Chapecó', pautas: ['Agronegócio', 'Direita Conservadora', 'Anti-corrupção'], top_cidades: [{cidade: 'Chapecó', votos: 45000}, {cidade: 'Xanxerê', votos: 20000}, {cidade: 'Concórdia', votos: 15000}] }, { nome: 'JORGE GOETTEN', votos: 159239, votos_blumenau: 15210, cidade: 'Rio do Sul', pautas: ['Cooperativismo', 'Desenvolvimento Regional', 'Educação'], top_cidades: [{cidade: 'Rio do Sul', votos: 25000}, {cidade: 'Ibirama', votos: 18000}, {cidade: 'Blumenau', votos: 15210}] }, { nome: 'JULIA ZANATTA', votos: 112323, votos_blumenau: 7100, cidade: 'Criciúma', pautas: ['Defesa do Armamento', 'Pautas Conservadoras', 'Liberdade Individual'], top_cidades: [{cidade: 'Criciúma', votos: 38000}, {cidade: 'Içara', votos: 12000}, {cidade: 'Blumenau', votos: 7100}] }, { nome: 'DANIEL FREITAS', votos: 101889, votos_blumenau: 6500, cidade: 'Criciúma', pautas: ['Saúde', 'Empreendedorismo', 'Segurança Pública'], top_cidades: [{cidade: 'Criciúma', votos: 35000}, {cidade: 'Tubarão', votos: 15000}, {cidade: 'Araranguá', votos: 12000}] }, { nome: 'ZE TROVÃO', votos: 74163, votos_blumenau: 5500, cidade: 'Joinville', pautas: ['Caminhoneiros', 'Direitos dos Trabalhadores', 'Combate ao STF'], top_cidades: [{cidade: 'Joinville', votos: 20000}, {cidade: 'Jaraguá do Sul', votos: 8000}, {cidade: 'Blumenau', votos: 5500}] }, { nome: 'JORGE ZIMMERMANN', votos: 69466, votos_blumenau: 12300, cidade: 'Blumenau', pautas: ['Gestão Pública', 'Infraestrutura Urbana', 'Tradições Locais'], top_cidades: [{cidade: 'Blumenau', votos: 12300}, {cidade: 'Gaspar', votos: 8000}, {cidade: 'Indaial', votos: 6000}] } ] }, 'PT': { votos: 547214, bancada: 3, eleitos: [ { nome: 'PEDRO UCZAI', votos: 173537, votos_blumenau: 5200, cidade: 'Chapecó', pautas: ['Agricultura Familiar', 'Educação Pública', 'Movimentos Sociais'], top_cidades: [{cidade: 'Chapecó', votos: 40000}, {cidade: 'Concórdia', votos: 18000}, {cidade: 'Xanxerê', votos: 12000}] }, { nome: 'ANA PAULA LIMA', votos: 148781, votos_blumenau: 35600, cidade: 'Blumenau', pautas: ['Direitos das Mulheres', 'Saúde Pública (SUS)', 'Trabalhismo'], top_cidades: [{cidade: 'Blumenau', votos: 35600}, {cidade: 'Gaspar', votos: 10000}, {cidade: 'Timbó', votos: 8000}] }, { nome: 'VALTOIR', votos: 68453, votos_blumenau: 1200, cidade: 'Joinville', pautas: ['Sindicatos', 'Direitos Trabalhistas', 'Indústria'], top_cidades: [{cidade: 'Joinville', votos: 25000}, {cidade: 'Jaraguá do Sul', votos: 7000}, {cidade: 'São Bento do Sul', votos: 5000}] } ] }, 'MDB': { votos: 428741, bancada: 2, eleitos: [ { nome: 'CARLOS CHIODINI', votos: 143876, votos_blumenau: 10500, cidade: 'Jaraguá do Sul', pautas: ['Indústria e Comércio', 'Desburocratização', 'Desenvolvimento Econômico'], top_cidades: [{cidade: 'Jaraguá do Sul', votos: 40000}, {cidade: 'Joinville', votos: 15000}, {cidade: 'Blumenau', votos: 10500}] }, { nome: 'RAFAEL PEZENTI', votos: 101889, votos_blumenau: 2100, cidade: 'Timbó', pautas: ['Municipalismo', 'Saúde Regional', 'Infraestrutura'], top_cidades: [{cidade: 'Timbó', votos: 20000}, {cidade: 'Indaial', votos: 12000}, {cidade: 'Rio dos Cedros', votos: 8000}] } ] }, 'PSD': { votos: 337963, bancada: 2, eleitos: [ { nome: 'ISMAEL', votos: 110531, votos_blumenau: 14500, cidade: 'Blumenau', pautas: ['Segurança Pública', 'Pautas Evangélicas', 'Assistência Social'], top_cidades: [{cidade: 'Blumenau', votos: 14500}, {cidade: 'Joinville', votos: 12000}, {cidade: 'Itajaí', votos: 10000}] }, { nome: 'RICARDO GUIDI', votos: 74066, votos_blumenau: 3500, cidade: 'Criciúma', pautas: ['Indústria Carbonífera', 'Desenvolvimento do Sul', 'Infraestrutura'], top_cidades: [{cidade: 'Criciúma', votos: 30000}, {cidade: 'Tubarão', votos: 10000}, {cidade: 'Içara', votos: 8000}] } ] }, 'PP': { votos: 365859, bancada: 1, eleitos: [ { nome: 'ANGELA AMIN', votos: 122737, votos_blumenau: 9800, cidade: 'Florianópolis', pautas: ['Gestão Municipal', 'Educação', 'Experiência Política'], top_cidades: [{cidade: 'Florianópolis', votos: 45000}, {cidade: 'São José', votos: 15000}, {cidade: 'Palhoça', votos: 10000}] } ] }, 'UNIÃO': { votos: 255301, bancada: 1, eleitos: [ { nome: 'FABIO SCHIOCHET', votos: 89367, votos_blumenau: 4200, cidade: 'Jaraguá do Sul', pautas: ['Empreendedorismo', 'Indústria Têxtil', 'Redução de Impostos'], top_cidades: [{cidade: 'Jaraguá do Sul', votos: 30000}, {cidade: 'Joinville', votos: 10000}, {cidade: 'Guaramirim', votos: 7000}] } ] }, 'PSDB': { votos: 183427, bancada: 1, eleitos: [ { nome: 'GEOVANIA DE SÁ', votos: 104533, votos_blumenau: 2900, cidade: 'Criciúma', pautas: ['Assistência Social', 'Direitos da Mulher', 'Saúde'], top_cidades: [{cidade: 'Criciúma', votos: 32000}, {cidade: 'Içara', votos: 11000}, {cidade: 'Araranguá', votos: 9000}] } ] },'NOVO': { votos: 158866, bancada: 1, eleitos: [ { nome: 'GILSON MARQUES', votos: 87894, votos_blumenau: 11500, cidade: 'Pomerode', pautas: ['Liberalismo', 'Menos Estado', 'Liberdade Econômica'], top_cidades: [{cidade: 'Pomerode', votos: 15000}, {cidade: 'Blumenau', votos: 11500}, {cidade: 'Joinville', votos: 10000}] } ] } } },
                        { ano: 2018, eleitorado: 5127453, votos_validos: 3591465, partidos: { 'PSL': { votos: 1102910 }, 'MDB': { votos: 437638 }, 'PT': { votos: 400492 }, 'PSD': { votos: 343213 }, 'PP': { votos: 298717 }, 'PSB': { votos: 148107 }, 'UNIÃO': { votos: 127977 }, 'PSDB': { votos: 123986 }, 'NOVO': { votos: 87894 } } }
                    ],
                    nao_eleitos: [
                        { nome: 'Ronaldo Baumgarten Jr', partido: 'UNIÃO', cidade: 'Blumenau', votos: 35000, votos_blumenau: 18500, top_cidades: [{cidade: 'Blumenau', votos: 18500}, {cidade: 'Gaspar', votos: 5000}, {cidade: 'Indaial', votos: 3000}] },
                        { nome: 'Ricardo Alba', partido: 'UNIÃO', cidade: 'Blumenau', votos: 28000, votos_blumenau: 15200, top_cidades: [{cidade: 'Blumenau', votos: 15200}, {cidade: 'Timbó', votos: 4000}, {cidade: 'Pomerode', votos: 2500}] },
                        { nome: 'Odair Tramontin', partido: 'NOVO', cidade: 'Blumenau', votos: 25000, votos_blumenau: 13100, top_cidades: [{cidade: 'Blumenau', votos: 13100}, {cidade: 'Joinville', votos: 3000}, {cidade: 'Jaraguá do Sul', votos: 2000}] },
                        { nome: 'Coronel Armando', partido: 'PL', cidade: 'Joinville', votos: 45000, votos_blumenau: 8200, top_cidades: [{cidade: 'Joinville', votos: 25000}, {cidade: 'Blumenau', votos: 8200}, {cidade: 'Jaraguá do Sul', votos: 4000}] },
                        { nome: 'Darci de Matos', partido: 'PSD', cidade: 'Joinville', votos: 42000, votos_blumenau: 6100, top_cidades: [{cidade: 'Joinville', votos: 22000}, {cidade: 'Blumenau', votos: 6100}, {cidade: 'São Francisco do Sul', votos: 3500}] },
                        { nome: 'Hélio Costa', partido: 'Republicanos', cidade: 'Florianópolis', votos: 38000, votos_blumenau: 5900, top_cidades: [{cidade: 'Florianópolis', votos: 18000}, {cidade: 'São José', votos: 7000}, {cidade: 'Blumenau', votos: 5900}] },
                        { nome: 'Carmen Zanotto', partido: 'Cidadania', cidade: 'Lages', votos: 55000, votos_blumenau: 4800, top_cidades: [{cidade: 'Lages', votos: 30000}, {cidade: 'São Joaquim', votos: 8000}, {cidade: 'Blumenau', votos: 4800}] },
                        { nome: 'Celso Maldaner', partido: 'MDB', cidade: 'Chapecó', votos: 48000, votos_blumenau: 3100, top_cidades: [{cidade: 'Chapecó', votos: 25000}, {cidade: 'Xanxerê', votos: 7000}, {cidade: 'Blumenau', votos: 3100}] },
                        { nome: 'Rodrigo Coelho', partido: 'Podemos', cidade: 'Joinville', votos: 22000, votos_blumenau: 2500, top_cidades: [{cidade: 'Joinville', votos: 12000}, {cidade: 'Blumenau', votos: 2500}, {cidade: 'Garuva', votos: 1500}] },
                        { nome: 'Guilherme da Cunha', partido: 'NOVO', cidade: 'Florianópolis', votos: 15000, votos_blumenau: 2200, top_cidades: [{cidade: 'Florianópolis', votos: 8000}, {cidade: 'Blumenau', votos: 2200}, {cidade: 'São José', votos: 1500}] },
                        { nome: 'Débora Dias', partido: 'PSOL', cidade: 'Florianópolis', votos: 12000, votos_blumenau: 1900, top_cidades: [{cidade: 'Florianópolis', votos: 7000}, {cidade: 'Blumenau', votos: 1900}, {cidade: 'Criciúma', votos: 800}] }
                    ]
                },
                'de': {
                    vagas: 40,
                    custo_medio_voto: 18.50,
                    historico: [
                        { ano: 2022, eleitorado: 5495133, votos_validos: 4124024, partidos: { 'PL': { votos: 882396, bancada: 11, eleitos: [ { nome: 'Ana Campagnolo', votos: 196571, votos_blumenau: 9130, cidade: 'Florianópolis', pautas: ['Defesa da Família', 'Valores Conservadores', 'Combate à Doutrinação Ideológica'], top_cidades: [{cidade: 'Florianópolis', votos: 25000}, {cidade: 'Joinville', votos: 15000}, {cidade: 'Blumenau', votos: 9130}] }, { nome: 'Sargento Lima', votos: 71185, votos_blumenau: 4793, cidade: 'Joinville', pautas: ['Segurança Pública', 'Ordem e Disciplina', 'Apoio aos Policiais'], top_cidades: [{cidade: 'Joinville', votos: 30000}, {cidade: 'Blumenau', votos: 4793}, {cidade: 'Jaraguá do Sul', votos: 4000}] }, { nome: 'Maurício Eskudlark', votos: 65638, votos_blumenau: 1096, cidade: 'Campos Novos', pautas: ['Agronegócio', 'Segurança no Campo', 'Infraestrutura Rural'], top_cidades: [{cidade: 'Campos Novos', votos: 15000}, {cidade: 'Chapecó', votos: 8000}, {cidade: 'Joaçaba', votos: 6000}] }, { nome: 'Jessé Lopes', votos: 55013, votos_blumenau: 3918, cidade: 'Criciúma', pautas: ['Direita Conservadora', 'Combate ao Comunismo', 'Liberdade de Expressão'], top_cidades: [{cidade: 'Criciúma', votos: 20000}, {cidade: 'Tubarão', votos: 7000}, {cidade: 'Blumenau', votos: 3918}] }, { nome: 'Carlos Humberto', votos: 46445, votos_blumenau: 3840, cidade: 'Baln. Camboriú', pautas: ['Turismo', 'Desenvolvimento Litorâneo', 'Gestão Municipal'], top_cidades: [{cidade: 'Baln. Camboriú', votos: 35000}, {cidade: 'Itajaí', votos: 10000}, {cidade: 'Blumenau', votos: 3840}] }, { nome: 'Ivan Naatz', votos: 45304, votos_blumenau: 21656, cidade: 'Blumenau', pautas: ['Turismo do Vale Europeu', 'Defesa do Consumidor', 'Tradições Germânicas'], top_cidades: [{cidade: 'Blumenau', votos: 21656}, {cidade: 'Gaspar', votos: 5000}, {cidade: 'Pomerode', votos: 4000}] }, { nome: 'Berlanda', votos: 41488, votos_blumenau: 184, cidade: 'Curitibanos', pautas: ['Indústria Moveleira', 'Desenvolvimento da Serra', 'Empreendedorismo'], top_cidades: [{cidade: 'Curitibanos', votos: 12000}, {cidade: 'Lages', votos: 6000}, {cidade: 'Campos Novos', votos: 4000}] }, { nome: 'Marcius Machado', votos: 39749, votos_blumenau: 100, cidade: 'Lages', pautas: ['Direita Conservadora', 'Segurança Pública', 'Serra Catarinense'] }, { nome: 'Massocco', votos: 31659, votos_blumenau: 197, cidade: 'Concórdia', pautas: ['Agronegócio', 'Cooperativismo', 'Desenvolvimento do Oeste'], top_cidades: [{cidade: 'Concórdia', votos: 18000}, {cidade: 'Chapecó', votos: 7000}, {cidade: 'Seara', votos: 5000}] }, { nome: 'Oscar Gutz', votos: 26812, votos_blumenau: 238, cidade: 'Taió', pautas: ['Agricultura', 'Defesa Civil', 'Desenvolvimento do Alto Vale'], top_cidades: [{cidade: 'Taió', votos: 10000}, {cidade: 'Rio do Sul', votos: 7000}, {cidade: 'Ibirama', votos: 5000}] }, { nome: 'Soratto', votos: 25622, votos_blumenau: 150, cidade: 'Tubarão', pautas: ['Desenvolvimento do Sul', 'Infraestrutura', 'Saúde'] } ] }, 'MDB': { votos: 505571, bancada: 6, eleitos: [ { nome: 'Antídio Lunelli', votos: 74500, votos_blumenau: 2493, cidade: 'Jaraguá do Sul', pautas: ['Indústria', 'Gestão Eficiente', 'Municipalismo'], top_cidades: [{cidade: 'Jaraguá do Sul', votos: 30000}, {cidade: 'Joinville', votos: 8000}, {cidade: 'Blumenau', votos: 2493}] }, { nome: 'Mauro de Nadal', votos: 67065, votos_blumenau: 899, cidade: 'Chapecó', pautas: ['Presidência da ALESC', 'Articulação Política', 'Agronegócio'], top_cidades: [{cidade: 'Chapecó', votos: 25000}, {cidade: 'Xanxerê', votos: 10000}, {cidade: 'Concórdia', votos: 5000}] }, { nome: 'Jerry Comper', votos: 64145, votos_blumenau: 362, cidade: 'Ibirama', pautas: ['Alto Vale do Itajaí', 'Infraestrutura Regional', 'Agricultura'], top_cidades: [{cidade: 'Ibirama', votos: 12000}, {cidade: 'Rio do Sul', votos: 8000}, {cidade: 'Presidente Getúlio', votos: 5000}] }, { nome: 'Fernando Krelling', votos: 54320, votos_blumenau: 2949, cidade: 'Joinville', pautas: ['Esporte', 'Qualidade de Vida', 'Desenvolvimento Urbano'], top_cidades: [{cidade: 'Joinville', votos: 22000}, {cidade: 'Blumenau', votos: 2949}, {cidade: 'Jaraguá do Sul', votos: 2500}] }, { nome: 'Volnei Weber', votos: 45995, votos_blumenau: 422, cidade: 'Orleans', pautas: ['Infraestrutura', 'Desenvolvimento do Sul', 'Saúde'], top_cidades: [{cidade: 'Orleans', votos: 15000}, {cidade: 'Criciúma', votos: 8000}, {cidade: 'Tubarão', votos: 6000}] }, { nome: 'Tiago Zilli', votos: 33733, votos_blumenau: 325, cidade: 'Turvo', pautas: ['Agricultura', 'Extremo Sul', 'Cooperativismo'], top_cidades: [{cidade: 'Turvo', votos: 10000}, {cidade: 'Araranguá', votos: 6000}, {cidade: 'Sombrio', votos: 4000}] } ] }, 'PT': { votos: 456849, bancada: 4, eleitos: [ { nome: 'Luciane Carminatti', votos: 92478, votos_blumenau: 1551, cidade: 'Chapecó', pautas: ['Educação Pública', 'Direitos Humanos', 'Servidores Públicos'], top_cidades: [{cidade: 'Chapecó', votos: 30000}, {cidade: 'Xanxerê', votos: 10000}, {cidade: 'Concórdia', votos: 7000}] }, { nome: 'Neodi Saretta', votos: 38729, votos_blumenau: 482, cidade: 'Concórdia', pautas: ['Saúde Pública', 'Desenvolvimento do Oeste', 'Agricultura'], top_cidades: [{cidade: 'Concórdia', votos: 20000}, {cidade: 'Chapecó', votos: 8000}, {cidade: 'Seara', votos: 6000}] }, { nome: 'Fabiano da Luz', votos: 34972, votos_blumenau: 554, cidade: 'Chapecó', pautas: ['Agricultura Familiar', 'Cooperativismo', 'Desenvolvimento Regional'], top_cidades: [{cidade: 'Chapecó', votos: 15000}, {cidade: 'Pinhalzinho', votos: 6000}, {cidade: 'Xaxim', votos: 4000}] }, { nome: 'Padre Pedro', votos: 26803, votos_blumenau: 662, cidade: 'Florianópolis', pautas: ['Movimentos Sociais', 'Direitos Humanos', 'Combate à Pobreza'], top_cidades: [{cidade: 'Florianópolis', votos: 20000}, {cidade: 'São José', votos: 7000}, {cidade: 'Palhoça', votos: 5000}] } ] }, 'Podemos': { votos: 218631, bancada: 3, eleitos: [ { nome: 'Paulinha', votos: 58694, votos_blumenau: 2383, cidade: 'Bombinhas', pautas: ['Municipalismo', 'Turismo', 'Direitos das Mulheres'], top_cidades: [{cidade: 'Bombinhas', votos: 15000}, {cidade: 'Porto Belo', votos: 10000}, {cidade: 'Itapema', votos: 8000}] }, { nome: 'Camilo Martins', votos: 44925, votos_blumenau: 287, cidade: 'Palhoça', pautas: ['Gestão Municipal', 'Desenvolvimento da Grande Fpolis', 'Segurança'], top_cidades: [{cidade: 'Palhoça', votos: 18000}, {cidade: 'São José', votos: 6000}, {cidade: 'Florianópolis', votos: 4000}] }, { nome: 'Lucas Neves', votos: 23053, votos_blumenau: 872, cidade: 'Lages', pautas: ['Serra Catarinense', 'Juventude', 'Inovação'], top_cidades: [{cidade: 'Lages', votos: 12000}, {cidade: 'São Joaquim', votos: 5000}, {cidade: 'Correia Pinto', votos: 3000}] } ] },'PP': { votos: 369639, bancada: 3, eleitos: [ { nome: 'Zé Milton', votos: 56585, votos_blumenau: 441, cidade: 'Sombrio', pautas: ['Infraestrutura', 'Agronegócio', 'Desenvolvimento do Sul'], top_cidades: [{cidade: 'Sombrio', votos: 20000}, {cidade: 'Araranguá', votos: 10000}, {cidade: 'Criciúma', votos: 7000}] }, { nome: 'Altair Silva', votos: 46445, votos_blumenau: 278, cidade: 'Chapecó', pautas: ['Agricultura', 'Cooperativismo', 'Desenvolvimento do Oeste'], top_cidades: [{cidade: 'Chapecó', votos: 20000}, {cidade: 'Xanxerê', votos: 8000}, {cidade: 'Concórdia', votos: 5000}] }, { nome: 'Pepê Collaço', votos: 28809, votos_blumenau: 227, cidade: 'Tubarão', pautas: ['Juventude', 'Esporte', 'Desenvolvimento do Sul'], top_cidades: [{cidade: 'Tubarão', votos: 15000}, {cidade: 'Criciúma', votos: 6000}, {cidade: 'Laguna', votos: 4000}] } ] }, 'PSD': { votos: 407801, bancada: 3, eleitos: [ { nome: 'Mário Motta', votos: 56363, votos_blumenau: 4194, cidade: 'Florianópolis', pautas: ['Comunicação', 'Cultura', 'Educação'], top_cidades: [{cidade: 'Florianópolis', votos: 28000}, {cidade: 'São José', votos: 9000}, {cidade: 'Blumenau', votos: 4194}] }, { nome: 'Júlio Garcia', votos: 49958, votos_blumenau: 4542, cidade: 'Florianópolis', pautas: ['Articulação Política', 'Experiência Legislativa', 'Gestão Pública'], top_cidades: [{cidade: 'Florianópolis', votos: 30000}, {cidade: 'São José', votos: 10000}, {cidade: 'Blumenau', votos: 4542}] }, { nome: 'Napoleão Bernardes', votos: 36923, votos_blumenau: 18085, cidade: 'Blumenau', pautas: ['Gestão Municipal', 'Desenvolvimento do Vale', 'Inovação'], top_cidades: [{cidade: 'Blumenau', votos: 18085}, {cidade: 'Gaspar', votos: 8000}, {cidade: 'Indaial', votos: 6000}] } ] },'UNIÃO': { votos: 286222, bancada: 3, eleitos: [ { nome: 'Jair Miotto', votos: 33682, votos_blumenau: 1258, cidade: 'Florianópolis', pautas: ['Pautas Evangélicas', 'Assistência Social', 'Família'], top_cidades: [{cidade: 'Florianópolis', votos: 12000}, {cidade: 'São José', votos: 5000}, {cidade: 'Palhoça', votos: 3000}] }, { nome: 'Repórter Sérgio Guimarães', votos: 27977, votos_blumenau: 788, cidade: 'Florianópolis', pautas: ['Comunicação', 'Liberalismo', 'Segurança Pública'], top_cidades: [{cidade: 'Florianópolis', votos: 10000}, {cidade: 'São José', votos: 4000}, {cidade: 'Biguaçu', votos: 2000}] }, { nome: 'Marcos da Rosa', votos: 25845, votos_blumenau: 11531, cidade: 'Blumenau', pautas: ['Gestão Pública', 'Desenvolvimento Econômico', 'Segurança'], top_cidades: [{cidade: 'Blumenau', votos: 11531}, {cidade: 'Gaspar', votos: 4000}, {cidade: 'Indaial', votos: 3000}] } ] }, 'PSDB': { votos: 183427, bancada: 2, eleitos: [ { nome: 'Marcos Vieira', votos: 48466, votos_blumenau: 1579, cidade: 'Florianópolis', pautas: ['Articulação Política', 'Infraestrutura', 'Desenvolvimento Estadual'], top_cidades: [{cidade: 'Florianópolis', votos: 20000}, {cidade: 'São José', votos: 8000}, {cidade: 'Palhoça', votos: 5000}] }, { nome: 'Dr. Vicente', votos: 39797, votos_blumenau: 1838, cidade: 'Jaraguá do Sul', pautas: ['Saúde', 'Direitos da Pessoa com Deficiência', 'Gestão'], top_cidades: [{cidade: 'Jaraguá do Sul', votos: 18000}, {cidade: 'Joinville', votos: 5000}, {cidade: 'Blumenau', votos: 1838}] } ] }, 'NOVO': { votos: 111760, bancada: 1, eleitos: [ { nome: 'Matheus Cadorin', votos: 12390, votos_blumenau: 2624, cidade: 'Joinville', pautas: ['Liberalismo', 'Empreendedorismo', 'Menos Impostos'], top_cidades: [{cidade: 'Joinville', votos: 15000}, {cidade: 'Blumenau', votos: 2624}, {cidade: 'Jaraguá do Sul', votos: 2000}] } ] }, 'PDT': { votos: 75934, bancada: 1, eleitos: [ { nome: 'Rodrigo Minotto', votos: 28685, votos_blumenau: 390, cidade: 'Criciúma', pautas: ['Trabalhismo', 'Educação', 'Desenvolvimento do Sul'], top_cidades: [{cidade: 'Criciúma', votos: 10000}, {cidade: 'Tubarão', votos: 4000}, {cidade: 'Içara', votos: 3000}] } ] }, 'PSOL': { votos: 94590, bancada: 1, eleitos: [ { nome: 'Marquito', votos: 40329, votos_blumenau: 1442, cidade: 'Florianópolis', pautas: ['Meio Ambiente', 'Agroecologia', 'Direitos Humanos'], top_cidades: [{cidade: 'Florianópolis', votos: 15000}, {cidade: 'São José', votos: 5000}, {cidade: 'Blumenau', votos: 1442}] } ] },'PTB': { votos: 85341, bancada: 1, eleitos: [ { nome: 'Delegado Egidio Ferrari', votos: 34912, votos_blumenau: 19831, cidade: 'Blumenau', pautas: ['Segurança Pública', 'Polícia Civil', 'Combate à Criminalidade'], top_cidades: [{cidade: 'Blumenau', votos: 19831}, {cidade: 'Indaial', votos: 3000}, {cidade: 'Gaspar', votos: 2000}]} ] },'Republicanos': { votos: 177977, bancada: 1, eleitos: [ { nome: 'Sergio Motta', votos: 44666, votos_blumenau: 1488, cidade: 'Florianópolis', pautas: ['Pautas Evangélicas', 'Comunicação', 'Defesa da Família'], top_cidades: [{cidade: 'Florianópolis', votos: 18000}, {cidade: 'São José', votos: 6000}, {cidade: 'Palhoça', votos: 4000}] } ] } }
                        },
                        { ano: 2018, eleitorado: 5127453, votos_validos: 3591465, partidos: { 'PL': { votos: 183110 }, 'MDB': { votos: 437638 }, 'PT': { votos: 400492 }, 'PSD': { votos: 343213 }, 'PP': { votos: 298717 }, 'PSB': { votos: 148107 }, 'União': { votos: 127977 }, 'PSDB': { votos: 123986 }, 'NOVO': { votos: 87894 }, 'PDT': { votos: 115000 }, 'PSOL': { votos: 75000 }, 'Republicanos': { votos: 95000 }, 'Podemos': { votos: 100000 } } }
                    ],
                    nao_eleitos: [
                        { nome: 'Ricardo Alba', partido: 'União', cidade: 'Blumenau', votos: 27500, votos_blumenau: 25432, top_cidades: [{cidade: 'Blumenau', votos: 25432}, {cidade: 'Gaspar', votos: 1000}, {cidade: 'Indaial', votos: 500}] },
                        { nome: 'Odair Tramontin', partido: 'NOVO', cidade: 'Blumenau', votos: 22000, votos_blumenau: 18750, top_cidades: [{cidade: 'Blumenau', votos: 18750}, {cidade: 'Joinville', votos: 1500}, {cidade: 'Jaraguá do Sul', votos: 1000}] },
                        { nome: 'Rolf Kaestner', partido: 'MDB', cidade: 'Blumenau', votos: 14000, votos_blumenau: 12345, top_cidades: [{cidade: 'Blumenau', votos: 12345}, {cidade: 'Pomerode', votos: 800}, {cidade: 'Timbó', votos: 500}] },
                        { nome: 'João Paulo Kleinübing', partido: 'União', cidade: 'Florianópolis', votos: 28000, votos_blumenau: 9500, top_cidades: [{cidade: 'Florianópolis', votos: 15000}, {cidade: 'Blumenau', votos: 9500}, {cidade: 'São José', votos: 2000}] },
                        { nome: 'Coronel Armando', partido: 'PL', cidade: 'Joinville', votos: 27500, votos_blumenau: 8200, top_cidades: [{cidade: 'Joinville', votos: 15000}, {cidade: 'Blumenau', votos: 8200}, {cidade: 'Jaraguá do Sul', votos: 2000}] },
                        { nome: 'Darci de Matos', partido: 'PSD', cidade: 'Joinville', votos: 26000, votos_blumenau: 6100, top_cidades: [{cidade: 'Joinville', votos: 14000}, {cidade: 'Blumenau', votos: 6100}, {cidade: 'São Francisco do Sul', votos: 1500}] },
                        { nome: 'Bianca Lins', partido: 'PT', cidade: 'Criciúma', votos: 15000, votos_blumenau: 5800, top_cidades: [{cidade: 'Criciúma', votos: 6000}, {cidade: 'Blumenau', votos: 5800}, {cidade: 'Florianópolis', votos: 1000}] },
                        { nome: 'Roberto Carlos', partido: 'PP', cidade: 'Lages', votos: 18000, votos_blumenau: 4500, top_cidades: [{cidade: 'Lages', votos: 10000}, {cidade: 'Blumenau', votos: 4500}, {cidade: 'São Joaquim', votos: 1000}] },
                        { nome: 'Ana Lucia', partido: 'PSOL', cidade: 'Florianópolis', votos: 16000, votos_blumenau: 3200, top_cidades: [{cidade: 'Florianópolis', votos: 10000}, {cidade: 'Blumenau', votos: 3200}, {cidade: 'São José', votos: 1000}] },
                        { nome: 'Marcos Andrade', partido: 'Podemos', cidade: 'Chapecó', votos: 14500, votos_blumenau: 2100, top_cidades: [{cidade: 'Chapecó', votos: 8000}, {cidade: 'Blumenau', votos: 2100}, {cidade: 'Xanxerê', votos: 1000}] },
                        { nome: 'Silvio da Silva', partido: 'Republicanos', cidade: 'Itajaí', votos: 13000, votos_blumenau: 1800, top_cidades: [{cidade: 'Itajaí', votos: 7000}, {cidade: 'Blumenau', votos: 1800}, {cidade: 'Navegantes', votos: 1000}] },
                        { nome: 'Carlos Pereira', partido: 'MDB', cidade: 'Tubarão', votos: 12000, votos_blumenau: 1500, top_cidades: [{cidade: 'Tubarão', votos: 7000}, {cidade: 'Blumenau', votos: 1500}, {cidade: 'Laguna', votos: 800}] },
                        { nome: 'Vanessa de Oliveira', partido: 'NOVO', cidade: 'Joinville', votos: 11000, votos_blumenau: 1300, top_cidades: [{cidade: 'Joinville', votos: 6000}, {cidade: 'Blumenau', votos: 1300}, {cidade: 'Jaraguá do Sul', votos: 800}] }
                    ]
                },
                'prefeito': {
                    'Blumenau': {
                        custo_medio_voto: 40.00,
                        historico: [
                            { ano: 2024, eleitorado: 261945, votos_validos: 185000, partidos: { 'PL': {votos: 95075}, 'NOVO': {votos: 55968} }, eleito: { nome: 'Egídio Ferrari', votos: 95075 } },
                            { ano: 2020, eleitorado: 245237, votos_validos: 160406, partidos: { 'PODE': {votos: 68222}, 'DEM': {votos: 24957} }, eleito: { nome: 'Mário Hildebrandt', votos: 68222 } }
                        ]
                    }
                },
                'vereador': {
                    'Blumenau': {
                        vagas: 15,
                        custo_medio_voto: 25.00,
                        bairros_data: {
                            'Fortaleza': { votos_validos: 12000 }, 'Velha': { votos_validos: 15000 }, 'Itoupava Norte': { votos_validos: 11000 },
                            'Centro': { votos_validos: 8000 }, 'Garcia': { votos_validos: 9000 }, 'Progresso': { votos_validos: 7000 },
                            'Itoupava Central': { votos_validos: 10000 }, 'Vila Nova': { votos_validos: 8500 }, 'Itoupavazinha': { votos_validos: 13000 },
                            'Água Verde': { votos_validos: 9500 }, 'Escola Agrícola': { votos_validos: 8800 }, 'Itoupava Seca': { votos_validos: 7500 },
                            'Ponta Aguda': { votos_validos: 6000 }, 'Testo Salto': { votos_validos: 6500 }, 'Salto do Norte': { votos_validos: 7200 },
                            'Badenfurt': { votos_validos: 8100 }, 'Victor Konder': { votos_validos: 5500 }, 'Jardim Blumenau': { votos_validos: 4000 },
                            'Boa Vista': { votos_validos: 5000 }
                        },
                        historico: [
                            { ano: 2024, eleitorado: 261945, votos_validos: 185000, partidos: { 'PL': { votos: 38000, bancada: 4, eleitos: [ { nome: 'Carlos da Silva', votos: 3500, top_bairros: [{bairro: 'Fortaleza', votos: 700}, {bairro: 'Velha', votos: 500}, {bairro: 'Itoupava Norte', votos: 450}] }, { nome: 'João Pereira', votos: 3100, top_bairros: [{bairro: 'Itoupavazinha', votos: 600}, {bairro: 'Testo Salto', votos: 350}, {bairro: 'Vila Itoupava', votos: 300}] }, { nome: 'Ana Souza', votos: 2800, top_bairros: [{bairro: 'Garcia', votos: 500}, {bairro: 'Progresso', votos: 350}, {bairro: 'Boa Vista', votos: 250}] }, { nome: 'Lucas Martins', votos: 2600, top_bairros: [{bairro: 'Velha', votos: 400}, {bairro: 'Vila Nova', votos: 300}, {bairro: 'Centro', votos: 200}] } ] }, 'NOVO': { votos: 25000, bancada: 2, eleitos: [ { nome: 'Pedro Almeida', votos: 2900, top_bairros: [{bairro: 'Centro', votos: 700}, {bairro: 'Jardim Blumenau', votos: 500}, {bairro: 'Victor Konder', votos: 400}] }, { nome: 'Mariana Costa', votos: 2400, top_bairros: [{bairro: 'Vila Nova', votos: 500}, {bairro: 'Velha', votos: 350}, {bairro: 'Água Verde', votos: 250}] } ] }, 'PSD': { votos: 22000, bancada: 1, eleitos: [ { nome: 'Silmara Miguel', votos: 4131, top_bairros: [{bairro: 'Garcia', votos: 900}, {bairro: 'Progresso', votos: 650}, {bairro: 'Valparaíso', votos: 450}] } ] }, 'MDB': { votos: 20000, bancada: 2, eleitos: [ { nome: 'José Santos', votos: 2500, top_bairros: [{bairro: 'Boa Vista', votos: 500}, {bairro: 'Itoupava Seca', votos: 350}, {bairro: 'Centro', votos: 250}] }, { nome: 'Fernanda Lima', votos: 2200, top_bairros: [{bairro: 'Velha', votos: 400}, {bairro: 'Garcia', votos: 300}, {bairro: 'Progresso', votos: 200}] } ] }, 'PT': { votos: 15000, bancada: 1, eleitos: [ { nome: 'Jean Volpato', votos: 4221, top_bairros: [{bairro: 'Progresso', votos: 800}, {bairro: 'Garcia', votos: 600}, {bairro: 'Glória', votos: 450}] } ] }, 'PP': { votos: 18000, bancada: 2, eleitos: [ { nome: 'Dr Marcelo Lanzarin', votos: 4016, top_bairros: [{bairro: 'Escola Agrícola', votos: 700}, {bairro: 'Água Verde', votos: 500}, {bairro: 'Salgado Filho', votos: 350}] }, { nome: 'Antonio Ferreira', votos: 2300, top_bairros: [{bairro: 'Itoupava Central', votos: 400}, {bairro: 'Fortaleza', votos: 300}, {bairro: 'Velha', votos: 250}] } ] }, 'Republicanos': { votos: 10000, bancada: 1, eleitos: [ { nome: 'Egídio Beckhauser', votos: 3736, top_bairros: [{bairro: 'Itoupavazinha', votos: 650}, {bairro: 'Fortaleza Alta', votos: 400}, {bairro: 'Testo Salto', votos: 300}] } ] }, 'PSDB': { votos: 9000, bancada: 1, eleitos: [ { nome: 'Alexandre Matias', votos: 2577, top_bairros: [{bairro: 'Itoupava Norte', votos: 520}, {bairro: 'Fortaleza', votos: 380}, {bairro: 'Ponta Aguda', votos: 300}] } ] } } },
                            { ano: 2020, eleitorado: 245237, votos_validos: 165604, partidos: { 'PODE': { votos: 25526, bancada: 3, eleitos: [ { nome: 'MARCOS DA ROSA', votos: 2753, top_bairros: [{bairro: 'Fortaleza', votos: 550}, {bairro: 'Velha', votos: 400}, {bairro: 'Itoupava Norte', votos: 350}] }, { nome: 'CRISTIANE LOUREIRO', votos: 2046, top_bairros: [{bairro: 'Velha', votos: 450}, {bairro: 'Vila Nova', votos: 300}, {bairro: 'Centro', votos: 250}] }, { nome: 'CEZAR CAMPESATTO', votos: 1308, top_bairros: [{bairro: 'Itoupava Central', votos: 300}, {bairro: 'Vila Itoupava', votos: 250}, {bairro: 'Testo Salto', votos: 200}] } ] },'NOVO': { votos: 15875, bancada: 1, eleitos: [ { nome: 'EMMANUEL SANTOS', votos: 2575, top_bairros: [{bairro: 'Centro', votos: 600}, {bairro: 'Victor Konder', votos: 450}, {bairro: 'Jardim Blumenau', votos: 300}] } ] }, 'PSDB': { votos: 11985, bancada: 2, eleitos: [ { nome: 'ALEXANDRE MATIAS', votos: 2577, top_bairros: [{bairro: 'Itoupava Norte', votos: 520}, {bairro: 'Fortaleza', votos: 380}, {bairro: 'Ponta Aguda', votos: 300}] }, { nome: 'MAURÍCIO GOLLO', votos: 1886, top_bairros: [{bairro: 'Vila Nova', votos: 400}, {bairro: 'Velha', votos: 250}, {bairro: 'Água Verde', votos: 200}] } ] }, 'PP': { votos: 10567, bancada: 2, eleitos: [ { nome: 'ALMIR VIEIRA', votos: 2200, top_bairros: [{bairro: 'Progresso', votos: 600}, {bairro: 'Garcia', votos: 400}, {bairro: 'Glória', votos: 300}] }, { nome: 'SILMARA SILVA', votos: 1912, top_bairros: [{bairro: 'Escola Agrícola', votos: 450}, {bairro: 'Água Verde', votos: 300}, {bairro: 'Salgado Filho', votos: 250}] } ] },'PATRIOTA': { votos: 14608, bancada: 1, eleitos: [ { nome: 'GILSON DE SOUZA', votos: 2414, top_bairros: [{bairro: 'Garcia', votos: 500}, {bairro: 'Progresso', votos: 350}, {bairro: 'Valparaíso', votos: 280}] } ] }, 'PSL': { votos: 13038, bancada: 1, eleitos: [ { nome: 'CARLOS WAGNER', votos: 2040, top_bairros: [{bairro: 'Itoupavazinha', votos: 550}, {bairro: 'Testo Salto', votos: 350}, {bairro: 'Fortaleza Alta', votos: 250}] } ] }, 'PT': { votos: 11211, bancada: 1, eleitos: [ { nome: 'ADRIANO PEREIRA', votos: 2699, top_bairros: [{bairro: 'Progresso', votos: 700}, {bairro: 'Garcia', votos: 500}, {bairro: 'Glória', votos: 350}] } ] }, 'MDB': { votos: 9625, bancada: 1, eleitos: [ { nome: 'JOVINO CARDOSO NETO', votos: 1533, top_bairros: [{bairro: 'Boa Vista', votos: 400}, {bairro: 'Centro', votos: 250}, {bairro: 'Itoupava Seca', votos: 200}] } ] }, 'PSD': { votos: 12698, bancada: 0, eleitos: [] } } }
                        ]
                    }
                }
            }
        };

        // --- INICIALIZAÇÃO ---
        window.onload = function() {
            const tipoEleicaoSelect = document.getElementById('tipoEleicao');
            const anoEleicaoSelect = document.getElementById('anoEleicao');
            const cidadeSelect = document.getElementById('cidade');

            const todosCargos = {
                'governador': 'Governador', 'senador': 'Senador',
                'df': 'Deputado Federal', 'de': 'Deputado Estadual', 'prefeito': 'Prefeito', 'vereador': 'Vereador'
            };
            Object.entries(todosCargos).forEach(([key, value]) => tipoEleicaoSelect.add(new Option(value, key)));
            
            tipoEleicaoSelect.addEventListener('change', atualizarOpcoes);
            anoEleicaoSelect.addEventListener('change', atualizarPartidos);
            cidadeSelect.addEventListener('change', atualizarOpcoes);
            
            atualizarOpcoes();
        };

        function atualizarOpcoes() {
            const tipoEleicao = document.getElementById('tipoEleicao').value;
            const cidadeGroup = document.getElementById('cidade-group');
            const anoEleicaoSelect = document.getElementById('anoEleicao');

            cidadeGroup.classList.toggle('hidden', !['vereador', 'prefeito'].includes(tipoEleicao));

            let dadosCenario;
            if (['vereador', 'prefeito'].includes(tipoEleicao)) {
                const cidadeSelect = document.getElementById('cidade');
                const cidadesDisponiveis = Object.keys(DADOS_ELEICOES['SC'][tipoEleicao]);
                const cidadeAtual = cidadeSelect.value;
                cidadeSelect.innerHTML = '';
                cidadesDisponiveis.forEach(cidade => cidadeSelect.add(new Option(cidade, cidade)));
                if (cidadesDisponiveis.includes(cidadeAtual)) cidadeSelect.value = cidadeAtual;
                dadosCenario = DADOS_ELEICOES['SC'][tipoEleicao][cidadeSelect.value];
            } else {
                dadosCenario = DADOS_ELEICOES['SC'][tipoEleicao];
            }

            // Popula o seletor de ano
            anoEleicaoSelect.innerHTML = '';
            if (dadosCenario && dadosCenario.historico) {
                dadosCenario.historico.forEach(eleicao => {
                    // Apenas adiciona anos que têm um histórico anterior para comparação
                    if (dadosCenario.historico.indexOf(eleicao) < dadosCenario.historico.length - 1) {
                         anoEleicaoSelect.add(new Option(eleicao.ano, eleicao.ano));
                    }
                });
            }
            
            atualizarPartidos();
        }

        function atualizarPartidos() {
            const tipoEleicao = document.getElementById('tipoEleicao').value;
            const cidade = document.getElementById('cidade').value;
            const anoEleicao = document.getElementById('anoEleicao').value;
            const partidoSelect = document.getElementById('partido-select');

            partidoSelect.innerHTML = '<option value="">-- Selecione --</option>';

            if (!anoEleicao) return; // Se não houver ano selecionado, não faz nada

            let dadosCenario;
            if (['vereador', 'prefeito'].includes(tipoEleicao)) {
                dadosCenario = DADOS_ELEICOES['SC']?.[tipoEleicao]?.[cidade];
            } else {
                dadosCenario = DADOS_ELEICOES['SC']?.[tipoEleicao];
            }

            if (dadosCenario) {
                const dadosDoAno = dadosCenario.historico.find(h => h.ano == anoEleicao);
                if (dadosDoAno && dadosDoAno.partidos) {
                    const partidos = Object.keys(dadosDoAno.partidos);
                    partidos.sort().forEach(p => partidoSelect.add(new Option(p, p)));
                }
            }
        }

        function isMajoritarian(cargo) {
            return ['governador', 'senador', 'prefeito'].includes(cargo);
        }

        function realizarAnalise() {
            const tipoEleicao = document.getElementById('tipoEleicao').value;
            const cidade = document.getElementById('cidade').value;
            const anoSelecionado = document.getElementById('anoEleicao').value;
            const partidoSelecionado = document.getElementById('partido-select').value;
            const resultadoDiv = document.getElementById('resultado-analise');

            if (!partidoSelecionado || !anoSelecionado) {
                resultadoDiv.innerHTML = `<div class="step-card p-6 text-center text-red-600 font-semibold">Por favor, selecione o ano e um partido para analisar.</div>`;
                resultadoDiv.classList.remove('hidden');
                return;
            }

            let dadosCenario;
            if (['vereador', 'prefeito'].includes(tipoEleicao)) {
                dadosCenario = DADOS_ELEICOES['SC']?.[tipoEleicao]?.[cidade];
            } else {
                dadosCenario = DADOS_ELEICOES['SC']?.[tipoEleicao];
            }
            
            const indexRecente = dadosCenario.historico.findIndex(h => h.ano == anoSelecionado);
            const historicoRecente = dadosCenario.historico[indexRecente];
            const historicoAnterior = dadosCenario.historico[indexRecente + 1];

            if (!historicoAnterior) {
                resultadoDiv.innerHTML = `<div class="step-card p-6 text-center text-red-600 font-semibold">Não há dados históricos suficientes para uma análise de tendência a partir de ${anoSelecionado}.</div>`;
                resultadoDiv.classList.remove('hidden');
                return;
            }

            const crescimentoEleitorado = (historicoRecente.eleitorado / historicoAnterior.eleitorado) - 1;
            
            let todasOportunidades = [];

            if (!isMajoritarian(tipoEleicao)) {
                 Object.keys(historicoRecente.partidos).forEach(nomePartido => {
                    const tendenciaPartidoOriginal = ((historicoRecente.partidos[nomePartido]?.votos || 0) / (historicoAnterior.partidos[nomePartido]?.votos || 1)) - 1;
                    const tendenciaPartido = Math.max(-0.02, Math.min(0.02, tendenciaPartidoOriginal));
                    const partidoDadosRecente = historicoRecente.partidos[nomePartido];
                    let metaVotos = 0;
                    
                    const numVagas = dadosCenario.vagas;
                    const proporcaoVotosValidos = historicoRecente.votos_validos / historicoRecente.eleitorado;
                    const eleitoradoProjetado = Math.floor(historicoRecente.eleitorado * (1 + crescimentoEleitorado));
                    const votosValidosProjetado = Math.floor(eleitoradoProjetado * proporcaoVotosValidos);
                    const quocienteEleitoralProjetado = Math.floor(votosValidosProjetado / numVagas);
                    
                    const votosPartidoRecente = historicoRecente.partidos[nomePartido]?.votos || 0;
                    const votosPartidoProjetado = Math.floor(votosPartidoRecente * (1 + tendenciaPartido));
                    const vagasProjetadas = Math.floor(votosPartidoProjetado / quocienteEleitoralProjetado);

                    if (partidoDadosRecente && partidoDadosRecente.eleitos && vagasProjetadas > 0) {
                        const eleitosOrdenados = [...partidoDadosRecente.eleitos].sort((a, b) => b.votos - a.votos);
                        const eleitoIndex = Math.min(eleitosOrdenados.length, vagasProjetadas) - 1;
                        const eleitoReferencia = eleitosOrdenados[eleitoIndex];
                        metaVotos = Math.ceil(eleitoReferencia.votos * (1 + tendenciaPartido));
                    } else {
                        metaVotos = Math.ceil(quocienteEleitoralProjetado * 0.10);
                    }
                    todasOportunidades.push({ nome: nomePartido, metaVotos: metaVotos, vagasProjetadas: vagasProjetadas });
                });
                todasOportunidades.sort((a, b) => a.metaVotos - b.metaVotos);
            }

            const tendenciaPartidoOriginal = ((historicoRecente.partidos[partidoSelecionado]?.votos || 0) / (historicoAnterior.partidos[partidoSelecionado]?.votos || 1)) - 1;
            const tendenciaPartido = Math.max(-0.02, Math.min(0.02, tendenciaPartidoOriginal));

            let metasDeVotos = [];
            let metasInfo = '';
            let custoEstimado = 0;
            let quocienteEleitoralProjetado = null;
            let vagasProjetadasPartido = null;

            if (isMajoritarian(tipoEleicao)) {
                const votosVencedor = historicoRecente.eleito.votos;
                const meta = Math.ceil(votosVencedor * (1 + crescimentoEleitorado));
                metasDeVotos.push({ posicao: 'Para Vencer', votos: meta });
                metasInfo = `Meta calculada projetando a votação do vencedor de ${historicoRecente.ano} com o crescimento do eleitorado.`;
                custoEstimado = meta * dadosCenario.custo_medio_voto;
            } else {
                const numVagas = dadosCenario.vagas;
                const proporcaoVotosValidos = historicoRecente.votos_validos / historicoRecente.eleitorado;
                const eleitoradoProjetado = Math.floor(historicoRecente.eleitorado * (1 + crescimentoEleitorado));
                const votosValidosProjetado = Math.floor(eleitoradoProjetado * proporcaoVotosValidos);
                quocienteEleitoralProjetado = Math.floor(votosValidosProjetado / numVagas);
                
                const votosPartidoRecente = historicoRecente.partidos[partidoSelecionado]?.votos || 0;
                const votosPartidoProjetado = Math.floor(votosPartidoRecente * (1 + tendenciaPartido));
                vagasProjetadasPartido = Math.floor(votosPartidoProjetado / quocienteEleitoralProjetado);

                const partidoDadosRecente = historicoRecente.partidos[partidoSelecionado];
                if (partidoDadosRecente && partidoDadosRecente.eleitos && partidoDadosRecente.eleitos.length > 0) {
                    const eleitosOrdenados = [...partidoDadosRecente.eleitos].sort((a, b) => b.votos - a.votos);
                    eleitosOrdenados.forEach((eleito, index) => {
                        metasDeVotos.push({
                            posicao: index + 1,
                            votos: Math.ceil(eleito.votos * (1 + tendenciaPartido))
                        });
                    });
                } else {
                    metasDeVotos.push({ posicao: 1, votos: Math.ceil(quocienteEleitoralProjetado * 0.10) });
                    metasInfo = `O partido não elegeu. A meta mínima é atingir 10% do QE projetado.`;
                }
                custoEstimado = (metasDeVotos[metasDeVotos.length - 1]?.votos || 0) * dadosCenario.custo_medio_voto;
            }

            renderizarResultados(metasDeVotos, custoEstimado, quocienteEleitoralProjetado, vagasProjetadasPartido, metasInfo, {
                crescimento: (crescimentoEleitorado * 100).toFixed(2),
                tendencia: (tendenciaPartido * 100).toFixed(2),
                anoAnterior: historicoAnterior.ano,
                anoRecente: historicoRecente.ano
            }, historicoRecente.partidos, historicoRecente.ano, tipoEleicao, dadosCenario, todasOportunidades);
        }

        function renderizarResultados(metasDeVotos, custoEstimado, QE, vagasPartido, metasInfo, projInfo, partidosBase, anoBase, tipoEleicao, dadosCenario, todasOportunidades) {
            const resultadoDiv = document.getElementById('resultado-analise');

            let metasHtml = metasDeVotos.sort((a, b) => b.votos - a.votos).map(meta => `
                <div class="flex justify-between items-center py-1">
                    <span class="font-semibold text-blue-800">Meta para ${meta.posicao}${typeof meta.posicao === 'number' ? 'ª vaga' : ''}:</span>
                    <span class="text-2xl font-bold text-blue-700">${meta.votos.toLocaleString('pt-BR')}</span>
                </div>
            `).join('');

            const tendenciaCor = projInfo.tendencia >= 0 ? 'text-green-600' : 'text-red-600';

            let html = `
                <div class="step-card p-6">
                    <h2 class="text-3xl font-bold text-gray-800 text-center mb-2">Projeção de Campanha</h2>
                    <p class="text-center text-gray-500 text-sm mb-6">Projeção baseada na variação de eleitorado e nas tendências de votos dos partidos entre ${projInfo.anoAnterior} e ${projInfo.anoRecente}.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center mb-8">
                        <div class="bg-blue-50 p-4 rounded-lg flex flex-col">
                            <p class="text-sm text-blue-800 font-semibold mb-2">METAS DE VOTOS PARA ELEIÇÃO</p>
                            <div class="space-y-2 flex-grow">${metasHtml}</div>
                             <div class="text-xs text-gray-500 mt-3 border-t pt-2">
                                <p>Crescimento do Eleitorado: <span class="font-semibold">${projInfo.crescimento}%</span></p>
                                <p>Tendência do Partido (Ajustada): <span class="font-semibold ${tendenciaCor}">${projInfo.tendencia}%</span></p>
                            </div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg flex flex-col">
                            <p class="text-sm text-green-800 font-semibold">
                                CUSTO ESTIMADO
                                <svg onclick="openCustoModal(${custoEstimado})" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block ml-1 text-gray-400 hover:text-blue-600 cursor-pointer" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                </svg>
                            </p>
                             <div class="flex-grow flex flex-col items-center justify-center">
                                <p class="text-4xl font-bold text-green-700">R$ ${custoEstimado.toLocaleString('pt-BR')}</p>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">Baseado na meta da última vaga (ou da vitória).</p>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg flex flex-col">
                            <p class="text-sm text-yellow-800 font-semibold">CUSTO MÉDIO POR VOTO</p>
                             <div class="flex-grow flex flex-col items-center justify-center">
                                <p class="text-4xl font-bold text-yellow-700">R$ ${dadosCenario.custo_medio_voto.toFixed(2).replace('.', ',')}</p>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">Valor de referência para o cargo selecionado.</p>
                        </div>
                    </div>
            `;
            
            if (!isMajoritarian(tipoEleicao)) {
                html += `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-center bg-gray-100 p-4 rounded-lg">
                        <div>
                            <p class="text-sm text-gray-500">Quociente Eleitoral Projetado</p>
                            <p class="text-2xl font-bold text-gray-800">${QE.toLocaleString('pt-BR')}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Vagas Projetadas para o Partido</p>
                            <p class="text-2xl font-bold text-gray-800">${vagasPartido > 0 ? vagasPartido : 'Nenhuma vaga direta'}</p>
                        </div>
                    </div>
                `;
            }

            html += `</div>`;
            
            if (!isMajoritarian(tipoEleicao)) {
                html += renderizarAnaliseOportunidade(todasOportunidades, anoBase);
            }
            
            if (!isMajoritarian(tipoEleicao) || tipoEleicao === 'senador') {
                 html += renderizarAnaliseForcaPartidaria(partidosBase, anoBase, tipoEleicao);
            }

            if (['de', 'df', 'senador'].includes(tipoEleicao)) {
                html += renderizarRankingBlumenau(partidosBase, anoBase);
                html += renderizarCabosEleitorais(dadosCenario.nao_eleitos, anoBase);
            }

            if (tipoEleicao === 'vereador') {
                html += renderizarAnaliseGeografica(partidosBase, anoBase, dadosCenario.bairros_data);
            }

            resultadoDiv.innerHTML = html;
            resultadoDiv.classList.remove('hidden');
        }

        function renderizarAnaliseForcaPartidaria(partidosBase, anoBase, tipoEleicao) {
            const partidos = Object.entries(partidosBase).map(([nome, dados]) => ({ nome, ...dados }));

            const grupos = {
                alta: partidos.filter(p => p.bancada >= 4).sort((a, b) => b.bancada - a.bancada),
                media: partidos.filter(p => p.bancada >= 2 && p.bancada < 4).sort((a, b) => b.bancada - a.bancada),
                pontual: partidos.filter(p => p.bancada === 1).sort((a, b) => b.votos - a.votos)
            };

            const criarListaPartidos = (lista) => {
                if (lista.length === 0) return '<p class="text-sm text-gray-500">Nenhum partido nesta categoria.</p>';
                return lista.map(p => {
                    const eleitos = p.eleitos || (p.eleito ? [p.eleito] : []);
                    const eleitosHtml = eleitos.map(c => {
                        let breakdown = '';
                        if (['de', 'df', 'senador'].includes(tipoEleicao) && c.votos_blumenau !== undefined) {
                            const votosFora = c.votos - c.votos_blumenau;
                            breakdown = ` <span class="text-gray-500">(${c.votos_blumenau.toLocaleString('pt-BR')} em BNU | ${votosFora.toLocaleString('pt-BR')} fora)</span>`;
                        } else if (tipoEleicao === 'vereador' && c.top_bairros) {
                            const bairroForte = c.top_bairros[0];
                            const percentualBairro = (bairroForte.votos / c.votos) * 100;
                            breakdown = ` <span class="text-gray-500">(Principal Bairro: ${bairroForte.bairro} - ${percentualBairro.toFixed(1)}%)</span>`;
                        }
                        return `<li>${c.nome} - ${c.votos.toLocaleString('pt-BR')} votos${breakdown}</li>`;
                    }).join('');
                    
                    return `
                    <div class="py-2">
                        <div class="flex justify-between items-center flex-wrap">
                            <h4 class="font-semibold text-gray-800">${p.nome} ${p.bancada ? `(${p.bancada} eleitos)` : ''}</h4>
                            <span class="font-bold text-gray-600 text-sm">${p.votos.toLocaleString('pt-BR')} votos de legenda</span>
                        </div>
                        <ul class="mt-1 pl-4 text-sm text-gray-600 list-disc list-inside">
                            ${eleitosHtml}
                        </ul>
                    </div>
                `}).join('<hr class="my-2">');
            };

            return `
                <div class="step-card p-6">
                    <h2 class="text-2xl font-bold text-gray-800 text-center mb-2">Análise de Força Partidária</h2>
                    <p class="text-center text-gray-600 mb-6">Classificação com base no desempenho da eleição de **${anoBase}** para este cargo.</p>
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-bold text-green-700 border-b-2 border-green-200 pb-2 mb-3">Alta Probabilidade</h3>
                            <p class="text-sm text-gray-600 mb-3">Partidos com as maiores bancadas e votações.</p>
                            <div class="space-y-2">${criarListaPartidos(grupos.alta)}</div>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-yellow-700 border-b-2 border-yellow-200 pb-2 mb-3">Média Probabilidade</h3>
                            <p class="text-sm text-gray-600 mb-3">Partidos que elegeram bancadas relevantes.</p>
                            <div class="space-y-2">${criarListaPartidos(grupos.media)}</div>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-red-700 border-b-2 border-red-200 pb-2 mb-3">Chances Pontuais</h3>
                            <p class="text-sm text-gray-600 mb-3">Partidos que geralmente elegem um representante.</p>
                            <div class="space-y-2">${criarListaPartidos(grupos.pontual)}</div>
                        </div>
                    </div>
                    <div class="mt-6 text-center">
                        <p class="text-xs text-gray-500">*Fonte: Dados compilados com base nos resultados oficiais do TSE. Variações podem ocorrer.</p>
                    </div>
                </div>
            `;
        }
        
        function renderizarRankingBlumenau(partidosBase, anoBase) {
            let todosEleitos = [];
            Object.values(partidosBase).forEach(dadosPartido => {
                const eleitos = dadosPartido.eleitos || (dadosPartido.eleito ? [dadosPartido.eleito] : []);
                todosEleitos.push(...eleitos.filter(e => e.votos_blumenau !== undefined));
            });

            todosEleitos.sort((a, b) => b.votos_blumenau - a.votos_blumenau);

            if (todosEleitos.length === 0) return '';

            let rankingHtml = todosEleitos.map((c, index) => {
                const detailsId = `details-rank-${index}`;
                const pautasHtml = (c.pautas || []).map(pauta => `<span class="inline-block bg-gray-200 rounded-full px-3 py-1 text-sm font-semibold text-gray-700 mr-2 mb-2">${pauta}</span>`).join('');
                const votosFora = c.votos - c.votos_blumenau;

                return `
                    <tr class="cursor-pointer hover:bg-gray-50" onclick="toggleDetails('${detailsId}')">
                        <td class="px-4 py-3 text-center">${index + 1}º</td>
                        <td class="px-4 py-3 font-semibold text-gray-900">
                             <div class="flex items-center">
                                <span>${c.nome}</span>
                                <svg id="arrow-${detailsId}" class="w-4 h-4 ml-2 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-gray-700">${c.cidade || 'N/A'}</td>
                        <td class="px-4 py-3 text-gray-700 text-right font-bold">${c.votos_blumenau.toLocaleString('pt-BR')}</td>
                        <td class="px-4 py-3 text-gray-700 text-right">${votosFora.toLocaleString('pt-BR')}</td>
                        <td class="px-4 py-3 text-gray-900 text-right font-semibold">${c.votos.toLocaleString('pt-BR')}</td>
                    </tr>
                    <tr id="${detailsId}" class="details-row">
                        <td colspan="6" class="details-cell">
                            <div class="p-4 bg-gray-100">
                                <h5 class="font-bold mb-2">Principais Pautas:</h5>
                                ${pautasHtml}
                                <p class="text-xs text-gray-500 mt-2">*Fonte: Resumo baseado em perfil público, notícias e atividade parlamentar.</p>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="step-card p-6">
                    <h2 class="text-2xl font-bold text-gray-800 text-center mb-2">Ranking de Votos em Blumenau</h2>
                    <p class="text-center text-gray-600 mb-6">Classificação dos candidatos eleitos em ${anoBase} com base na votação obtida no município.</p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Pos.</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Candidato</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Cidade de Origem/Base</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Votos em BNU</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Votos Fora</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Total</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${rankingHtml}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderizarCabosEleitorais(naoEleitos, anoBase) {
            if (!naoEleitos || naoEleitos.length === 0) return '';
            
            const cabosBlumenau = naoEleitos.filter(c => c.cidade === 'Blumenau').sort((a,b) => b.votos_blumenau - a.votos_blumenau);
            const cabosOutros = naoEleitos.filter(c => c.cidade !== 'Blumenau').sort((a,b) => b.votos_blumenau - a.votos_blumenau);
            const todosCabos = [...cabosBlumenau, ...cabosOutros];


            let cabosHtml = todosCabos.map((c, index) => {
                const detailsId = `details-cabos-${index}`;
                const topCidadesHtml = (c.top_cidades || []).map(city => `<li>${city.cidade}: ${city.votos.toLocaleString('pt-BR')} votos</li>`).join('');

                return `
                    <tr class="cursor-pointer hover:bg-gray-50" onclick="toggleDetails('${detailsId}')">
                        <td class="px-4 py-3 font-semibold text-gray-900">
                            <div class="flex items-center">
                                <span>${c.nome} <span class="text-gray-500 font-normal">(${c.partido})</span></span>
                                <svg id="arrow-${detailsId}" class="w-4 h-4 ml-2 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-gray-700">${c.cidade}</td>
                        <td class="px-4 py-3 text-gray-700 text-right">${c.votos_blumenau.toLocaleString('pt-BR')}</td>
                        <td class="px-4 py-3 text-gray-900 font-semibold text-right">${c.votos.toLocaleString('pt-BR')}</td>
                    </tr>
                    <tr id="${detailsId}" class="details-row">
                        <td colspan="4" class="details-cell">
                            <div class="p-4 bg-gray-100">
                                <h5 class="font-bold mb-2">Principais Cidades de Votação:</h5>
                                <ul class="text-sm text-gray-600 list-disc list-inside">${topCidadesHtml}</ul>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="step-card p-6">
                    <h2 class="text-2xl font-bold text-gray-800 text-center mb-2">Potenciais Aliados e Cabos Eleitorais</h2>
                    <p class="text-center text-gray-600 mb-6">Candidatos não eleitos em ${anoBase} com votação expressiva em Blumenau (ordenados por relevância local).</p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Candidato</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Cidade de Origem/Base</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Votos em BNU</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Votos Totais</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${cabosHtml}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        let bairroChartInstance = null;
        function renderizarAnaliseGeografica(partidosBase, anoBase, bairrosData) {
            const bairros = Object.keys(bairrosData).sort();
            let bairroOptions = bairros.map(b => `<option value="${b}">${b}</option>`).join('');

            const html = `
                <div class="step-card p-6">
                    <h2 class="text-2xl font-bold text-gray-800 text-center mb-2">Análise Geográfica de Votos por Bairro</h2>
                    <p class="text-center text-gray-600 mb-6">Veja a força dos vereadores eleitos em ${anoBase} em cada bairro de Blumenau.</p>
                    <div class="mb-4">
                        <label for="bairro-select" class="block text-sm font-medium text-gray-700 mb-1">Selecione um Bairro</label>
                        <select id="bairro-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            ${bairroOptions}
                        </select>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                        <div>
                            <canvas id="bairroChart"></canvas>
                        </div>
                        <div id="bairro-analise-oportunidade"></div>
                    </div>
                </div>
            `;

            setTimeout(() => {
                document.getElementById('bairro-select').addEventListener('change', (event) => {
                    atualizarGraficoBairro(event.target.value, partidosBase, bairrosData);
                });
                atualizarGraficoBairro(bairros[0], partidosBase, bairrosData);
            }, 0);

            return html;
        }
        
        function renderizarAnaliseOportunidade(oportunidades, anoBase) {
            if (!oportunidades || oportunidades.length === 0) return '';

            const minVotos = Math.min(...oportunidades.map(op => op.metaVotos));
            const maxVotos = Math.max(...oportunidades.map(op => op.metaVotos));
            const range = maxVotos - minVotos;

            let oportunidadesHtml = oportunidades.map(op => {
                let cor = 'bg-yellow-100';
                if (range > 0) {
                    if (op.metaVotos < minVotos + range / 3) {
                        cor = 'bg-green-100';
                    } else if (op.metaVotos > minVotos + (2 * range) / 3) {
                        cor = 'bg-red-100';
                    }
                }
                
                return `
                <tr class="${cor}">
                    <td class="px-4 py-3 font-semibold text-gray-900">${op.nome}</td>
                    <td class="px-4 py-3 text-gray-700 text-center">${op.vagasProjetadas > 0 ? op.vagasProjetadas : 'Nenhuma'}</td>
                    <td class="px-4 py-3 text-gray-900 font-semibold text-right">${op.metaVotos.toLocaleString('pt-BR')}</td>
                </tr>
            `}).join('');

            return `
                <div class="step-card p-6">
                    <h2 class="text-2xl font-bold text-gray-800 text-center mb-2">Análise de Oportunidade de Partido</h2>
                    <p class="text-center text-gray-600 mb-6">Ranking de partidos com a menor "nota de corte" para conquistar uma vaga, com base na projeção da eleição de ${anoBase}.</p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Partido</th>
                                    <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Vagas Projetadas</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Meta de Votos para Última Vaga</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${oportunidadesHtml}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function atualizarGraficoBairro(bairro, partidosBase, bairrosData) {
            const ctx = document.getElementById('bairroChart').getContext('2d');
            let todosEleitos = [];
            Object.values(partidosBase).forEach(dadosPartido => {
                if (dadosPartido.eleitos) {
                    todosEleitos.push(...dadosPartido.eleitos);
                }
            });

            const votosNoBairro = todosEleitos.map(eleito => {
                const bairroData = (eleito.top_bairros || []).find(b => b.bairro === bairro);
                return {
                    nome: eleito.nome.split(' ')[0], 
                    votos: bairroData ? bairroData.votos : 0
                };
            }).filter(e => e.votos > 0);

            const labels = votosNoBairro.map(e => e.nome);
            const data = votosNoBairro.map(e => e.votos);

            if (bairroChartInstance) {
                bairroChartInstance.destroy();
            }

            bairroChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#6366F1', '#14B8A6', '#F97316', '#DC2626', '#7C3AED', '#DB2777', '#4F46E5', '#059669', '#EA580C'],
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    const value = context.raw;
                                    const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}${value.toLocaleString('pt-BR')} votos (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            const totalVotosEleitosNoBairro = data.reduce((a, b) => a + b, 0);
            const totalVotosValidosBairro = bairrosData[bairro].votos_validos;
            const concentracao = (totalVotosEleitosNoBairro / totalVotosValidosBairro) * 100;
            
            let analiseHtml = `
                <h4 class="font-bold text-lg text-gray-800 mb-2">Análise de Oportunidade</h4>
                <p class="text-sm text-gray-600">No bairro ${bairro}, os <strong>vereadores eleitos</strong> somaram <strong>${totalVotosEleitosNoBairro.toLocaleString('pt-BR')}</strong> votos.</p>
                <p class="text-sm text-gray-600 mt-2">Isso representa um Índice de Concentração de:</p>
                <p class="text-4xl font-bold ${concentracao > 50 ? 'text-red-500' : 'text-green-500'} my-2">${concentracao.toFixed(1)}%</p>
            `;
            if (concentracao <= 50) {
                analiseHtml += `<p class="text-sm text-green-700 bg-green-100 p-2 rounded-md"><strong>Alto Potencial:</strong> Um baixo índice de concentração indica que os votos são pulverizados, representando uma excelente oportunidade para novos candidatos conquistarem espaço.</p>`;
            } else {
                analiseHtml += `<p class="text-sm text-red-700 bg-red-100 p-2 rounded-md"><strong>Baixo Potencial:</strong> Um alto índice de concentração indica que os vereadores eleitos possuem uma base sólida neste bairro, tornando a disputa mais desafiadora.</p>`;
            }
            document.getElementById('bairro-analise-oportunidade').innerHTML = analiseHtml;
        }

        function toggleDetails(detailsId) {
            const detailsRow = document.getElementById(detailsId);
            const arrow = document.getElementById(`arrow-${detailsId}`);
            detailsRow.classList.toggle('show');
            arrow.classList.toggle('rotate-180');
        }

        function openCustoModal(custoTotal) {
            const modalBody = document.getElementById('modal-custo-body');
            const percentuais = {
                grafico: 0.25,
                digital: 0.30,
                equipe: 0.20,
                logistica: 0.15,
                servicos: 0.10
            };

            modalBody.innerHTML = `
                <div class="space-y-3 text-sm">
                    <div>
                        <h4 class="font-semibold text-gray-700">Material Gráfico (25%)</h4>
                        <p class="text-gray-600">Santinhos, adesivos, panfletos, etc. - <span class="font-bold">R$ ${(custoTotal * percentuais.grafico).toLocaleString('pt-BR')}</span></p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-700">Marketing Digital (30%)</h4>
                        <p class="text-gray-600">Impulsionamento, produção de vídeos, etc. - <span class="font-bold">R$ ${(custoTotal * percentuais.digital).toLocaleString('pt-BR')}</span></p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-700">Equipe e Pessoal (20%)</h4>
                        <p class="text-gray-600">Militância de rua, coordenadores, etc. - <span class="font-bold">R$ ${(custoTotal * percentuais.equipe).toLocaleString('pt-BR')}</span></p>
                    </div>
                     <div>
                        <h4 class="font-semibold text-gray-700">Logística e Estrutura (15%)</h4>
                        <p class="text-gray-600">Combustível, carro de som, etc. - <span class="font-bold">R$ ${(custoTotal * percentuais.logistica).toLocaleString('pt-BR')}</span></p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-700">Serviços Obrigatórios (10%)</h4>
                        <p class="text-gray-600">Contador e Advogado para prestação de contas. - <span class="font-bold">R$ ${(custoTotal * percentuais.servicos).toLocaleString('pt-BR')}</span></p>
                    </div>
                </div>
            `;

            document.getElementById('custo-modal').classList.remove('hidden');
        }

        function closeCustoModal() {
            document.getElementById('custo-modal').classList.add('hidden');
        }

    </script>
</body>
</html>
